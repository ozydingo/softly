<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Rails is Ridiculous</title>
  <meta name="description" content="Part 1 of many to come">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="speaksoftly.io/2017/03/30/rails-is-ridiculous.html">
  <link rel="alternate" type="application/rss+xml" title="Speak Softly" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">Speak Softly</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Rails is Ridiculous</h1>
    <p class="post-meta"><time datetime="2017-03-30T17:32:39-04:00" itemprop="datePublished">Mar 30, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="part-1-of-many-to-come">Part 1 of many to come</h2>

<p>“Convention over configuration”. So the saying goes.</p>

<p>While often applied to Rails’ ability to create a lot of functionality with relatively spares amounts of code, I also take a liking to this saying as synonymous with the principle of least surpise: code design should pack as few surprises as possible while accomplishing its goals. You take advantage of this philosophy every time you assume <code class="highlighter-rouge">to_s</code> returns a reasonable String representation of any object, or that <code class="highlighter-rouge">.nil?</code> returns a Boolean value according to whether or not ab object is <code class="highlighter-rouge">nil</code>. Technically, a codeing ne’er-do-well could easily write the <code class="highlighter-rouge">nil?</code> class to return a random number. In Ruby, they could just as eaily overwrite the <code class="highlighter-rouge">nil?</code> method on <code class="highlighter-rouge">Object</code>, which would of course screw up a lot.</p>

<p>I’ve already hinted at how <a href="/2016/07/28/objectification.html">Rails disobeys this principle</a> more than I’m confortable with. However I recently came upon a bug-inducing example that really took be aback. So now I’m going to write about it.</p>

<p>As a convenience, I had written a <code class="highlighter-rouge">lower_bound</code>, <code class="highlighter-rouge">upper_bound</code>, and <code class="highlighter-rouge">bound</code> method into the <code class="highlighter-rouge">Numeric</code> class in an application – I could just no longer abide using using the ‘min’ method to mean upped bound and <code class="highlighter-rouge">max</code> for lower bound. “But wait,” you say, “isn’t that doing exactly the objectification that you just said in that post that you hate doing?” I mean, yeah, a little, but this is for convenience in a specific application, not for a gem or framework that will be distributed and imported in other applications. It’s just easier and more fun to write <code class="highlighter-rouge">x.upper_bound(3.0)</code> than something like <code class="highlighter-rouge">Bounder.new(x).upper_bound(3.0)</code>. But no, I would never be so presumptuous in a gem for distribution, thanks for asking.</p>

<p>Anyway, to the point. I wanted to expand this method to <code class="highlighter-rouge">DateTime</code> objects as well. So where to put it? Our app uses time zones extensively, so <code class="highlighter-rouge">ActiveSupport::TimeWithZone</code> as well as plain old <code class="highlighter-rouge">Time</code> need this method. Luckily:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Time</span><span class="p">)</span>
<span class="c1"># =&gt; true</span>
</code></pre>
</div>

<p>Wonderful! Just put it on <code class="highlighter-rouge">Time</code> and we’re set! I do so with a <code class="highlighter-rouge">core_ext/time.rb</code> file. But then I notice something funny:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span>
<span class="c1"># =&gt; Thu, 30 Mar 2017 18:08:29 EDT -04:00</span>
<span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">lower_bound</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
<span class="c1"># =&gt; Thu, 30 Mar 2017 18:08:30 EDT -04:00</span>
<span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">lower_bound</span><span class="p">(</span><span class="mi">30</span><span class="p">.</span><span class="nf">minutes</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
<span class="c1"># =&gt; Thu, 30 Mar 2017 17:38:32 EDT -04:00</span>
</code></pre>
</div>

<p>Huh? Lower-bounding by a day ago worked as expected (no change), but lower-bounding by half an hour ago returns half an hour ago? I could have probed further to discover that the 4-hour time zone shift was the cutoff for this weird behavior, but this time I went straight for the pry:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">lower_bound</span><span class="p">(</span><span class="mi">30</span><span class="p">.</span><span class="nf">minutes</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>

<span class="no">From</span><span class="p">:</span> <span class="sr">/Users/</span><span class="n">andrew</span><span class="o">/</span><span class="mi">3</span><span class="nb">p</span><span class="o">/</span><span class="n">app3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">boundable</span><span class="p">.</span><span class="nf">rb</span> <span class="err">@</span> <span class="n">line</span> <span class="mi">7</span> <span class="no">Boundable</span><span class="c1">#lower_bound:</span>

     <span class="mi">6</span><span class="p">:</span> <span class="k">def</span> <span class="nf">lower_bound</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
 <span class="o">=&gt;</span>  <span class="mi">7</span><span class="p">:</span>   <span class="nb">binding</span><span class="p">.</span><span class="nf">hpry</span>
     <span class="mi">8</span><span class="p">:</span>   <span class="k">if</span> <span class="nb">self</span> <span class="o">&lt;</span> <span class="n">bound</span>
     <span class="mi">9</span><span class="p">:</span>     <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:coerce</span><span class="p">)</span> <span class="p">?</span> <span class="n">coerce</span><span class="p">(</span><span class="n">bound</span><span class="p">).</span><span class="nf">first</span> <span class="p">:</span> <span class="n">bound</span>
    <span class="mi">10</span><span class="p">:</span>   <span class="k">else</span>
    <span class="mi">11</span><span class="p">:</span>     <span class="nb">self</span>
    <span class="mi">12</span><span class="p">:</span>   <span class="k">end</span>
    <span class="mi">13</span><span class="p">:</span> <span class="k">end</span>

<span class="nb">self</span>
<span class="c1"># =&gt; 2017-03-30 18:46:45 UTC</span>
<span class="n">bound</span>
<span class="c1"># =&gt; Thu, 30 Mar 2017 18:16:45 EDT -04:00</span>
<span class="nb">self</span> <span class="o">&lt;</span> <span class="n">bound</span>
<span class="c1"># =&gt; true</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">class</span>
<span class="c1"># =&gt; Time</span>
<span class="n">bound</span><span class="p">.</span><span class="nf">class</span>
<span class="c1"># =&gt; ActiveSupport::TimeWithZone</span>
</code></pre>
</div>

<p>To summarize, “now” is apparently less than “30 minutes ago”. More precisely, the object returned by <code class="highlighter-rouge">Time.zone.now</code> is evaluating as less than <code class="highlighter-rouge">30.minutes.ago</code>, because when evaluating this line of code, <code class="highlighter-rouge">self</code> is a regular <code class="highlighter-rouge">Time</code> object (in UTC), and is being compared against a <code class="highlighter-rouge">ActiveSupport::TimeWithZone</code> object, but as a regular <code class="highlighter-rouge">Time</code> object it doesn’t know about time zones.</p>

<p>But why did <code class="highlighter-rouge">self</code> forget about its true identity as a <code class="highlighter-rouge">TimeWithZone</code>? Let’s sanity check how we’re getting into this method:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:lower_bound</span><span class="p">).</span><span class="nf">owner</span>
<span class="c1"># =&gt; ActiveSupport::TimeWithZone</span>
<span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:lower_bound</span><span class="p">).</span><span class="nf">source_location</span>
<span class="c1"># =&gt; nil</span>
<span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:lower_bound</span><span class="p">).</span><span class="nf">source_location</span>
<span class="c1"># =&gt; ["/Users/andrew/3p/app3/lib/boundable.rb", 6]</span>
</code></pre>
</div>

<p>So the owner is <code class="highlighter-rouge">ActiveSupport::TimeWithZone</code>, but there’s not source location? Except there is for a regular <code class="highlighter-rouge">Time</code> object? We need more basic sanity checking:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">superclass</span>
 <span class="o">=&gt;</span> <span class="no">Object</span>
 <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">ancestors</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="no">Time</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="kp">false</span>
</code></pre>
</div>

<p>So <code class="highlighter-rouge">ActiveSupport::TimeWithZone</code> ingerits directly from <code class="highlighter-rouge">Object</code>, not from the <code class="highlighter-rouge">Time</code> class in any way. We already cofirmed that <code class="highlighter-rouge">Time.zone.now.is_a?(Time)</code>; this appears to contradict that finding. Let’s get to the stack trace using <code class="highlighter-rouge">caller</code> in the pry. Highlighting just the relevant portion, we have:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"/Users/andrew/3p/app3/lib/boundable.rb:7:in `lower_bound'",
"/Users/andrew/.rvm/gems/ruby-2.3.3/gems/activesupport-4.2.3/lib/active_support/time_with_zone.rb:371:in `method_missing'",
</code></pre>
</div>

<p>Ah, the dreaded “method_missing” pattern. I have found few valid uses of <code class="highlighter-rouge">method_missing</code>, and this, in ActiveSupport’s very own <code class="highlighter-rouge">time_with_zone.rb</code>, is <strong>NOT</strong> one of them:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code>    <span class="c1"># Send the missing method to +time+ instance, and wrap result in a new</span>
    <span class="c1"># TimeWithZone with the existing +time_zone+.</span>
    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">wrap_with_time_zone</span> <span class="n">time</span><span class="p">.</span><span class="nf">__send__</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">rescue</span> <span class="no">NoMethodError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">raise</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">inspect</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="nf">inspect</span><span class="p">),</span> <span class="n">e</span><span class="p">.</span><span class="nf">backtrace</span>
    <span class="k">end</span>
</code></pre>
</div>

<p>Here, <code class="highlighter-rouge">time</code>, of class <code class="highlighter-rouge">Time</code>, is an instance variable belonging to <code class="highlighter-rouge">TimeWithZone</code>, and this is the object that gave us the bug by not being able to correclty compare itself to <code class="highlighter-rouge">bound</code>, above. This <code class="highlighter-rouge">method_missing</code> pattern appears to evaluate the unknown method on the zone-normalized local <code class="highlighter-rouge">Time</code> object, because the authors thought that would basically be good enough. In a way it’s impementing a poor-man’s inheritance scheme. It works for the most part, but causes slippery bugs in edge cases such as ours: the <code class="highlighter-rouge">&lt;</code> method returned the wrong result against a <code class="highlighter-rouge">TimeWithZone</code> object. Surprise!</p>

<p>More generally, if <code class="highlighter-rouge">sym</code> here is a method that calls any other method overwritten by <code class="highlighter-rouge">TimeWithZone</code>, this will not work correctly. Turns out, as much as Rubyists diss inheritance, <code class="highlighter-rouge">method_missing</code> is not actually a good substitute for it. Who’d have thought?</p>

<p>Edge cases are fine to overlook in an application as a business decision, but the more general and distributed your code gets the more important it should be to have all edge cases make some logical sense. This case does not. In a package as widespread as Rails, decisions like these are just sloppy.</p>

<p>For our use case here, I just slapped the same methods on <code class="highlighter-rouge">ActiveSupport::TimeWithZone</code> as well, despire them already being included in <code class="highlighter-rouge">Time</code>, which we’re supposed to get for free except for the fact that someone thought <code class="highlighter-rouge">method_missing</code> was an effective substitute for inheritance.</p>

<p>I wasn’t done digging: we still have this hanging fact that <code class="highlighter-rouge">Time.zone.now.is_a?(Time)</code>. Turns out:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:is_a?</span><span class="p">).</span><span class="nf">source_location</span>
<span class="c1"># =&gt; ["/Users/andrew/.rvm/gems/ruby-2.3.3/gems/activesupport-4.2.3/lib/active_support/time_with_zone.rb", 334]</span>
</code></pre>
</div>

<p>You overwrote <code class="highlighter-rouge">is_a?</code>. You freakin overwrote <code class="highlighter-rouge">is_a?</code>.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code>    <span class="c1"># Say we're a Time to thwart type checking.</span>
    <span class="k">def</span> <span class="nf">is_a?</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
      <span class="n">klass</span> <span class="o">==</span> <span class="o">::</span><span class="no">Time</span> <span class="o">||</span> <span class="k">super</span>
    <span class="k">end</span>
</code></pre>
</div>

<p>Hacktastic.</p>

<p>That cuts deep, Rails. Too bad I just can’t quit you…</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Speak Softly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Speak Softly
            
            </li>
            
            <li><a href="mailto:ozydingo@gmail.com">ozydingo@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/ozydingo"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">ozydingo</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/ozydingo"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">ozydingo</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>A blog about coding awesome, powerful tools...respectfully
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
