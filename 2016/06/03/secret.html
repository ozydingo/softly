<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>secret</title>
  <meta name="description" content="Add features to a core class (ActiveRecord) without really adding them tl; dr">

  <link rel="stylesheet" href="/docs/assets/main.css">
  <link rel="canonical" href="speaksoftly.io/docs/2016/06/03/secret.html">
  <link rel="alternate" type="application/rss+xml" title="Speak Softly" href="/docs/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/docs/">Speak Softly</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
          <a class="page-link" href="/docs/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">secret</h1>
    <p class="post-meta"><time datetime="2016-06-03T09:15:10-04:00" itemprop="datePublished">Jun 3, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="add-features-to-a-core-class-activerecord-without-really-adding-them">Add features to a core class (ActiveRecord) without really adding them</h2>
<p><a href="#tl-dr-secret">tl; dr</a></p>

<p>I’ve been keeping a file of extensions to ActiveRecord that I find useful. I’ve blooged about one of them already. In many cases, while poking around our app in the console, I’ve wanted to use some of these features. To the extent that my toys are confined to their own modules, that’s fine, but I feel a little sketchy about adding a list of untested features to <code class="highlighter-rouge">ActiveRecord::Base</code>. Other developers in my team start finding and using them, then we discover a bug, and I don’t have time to support it, and we have a mess. So these extensions had not, until recently made it into our app.</p>

<p>However, there came a time when I really wanted one of these features actually used by our app. Specifically, <code class="highlighter-rouge">bulk_insert</code> for a <code class="highlighter-rouge">JobAccess</code> model – I’ll write a post about it soon. This was going to be a huge time save in a cricitcal part of our app. I was comfortable using my <code class="highlighter-rouge">bulk_insert</code> extension for this case beause I knew its behavior well enough to know that it would work with this model. And I wanted to use clean code rather than writing out manual SQL that would be a pain to maintain and update as the model changed. Nevertheless, I still didn’t want it generally available, at least easily, much less other features in my <code class="highlighter-rouge">ActiveRecordExtensions</code> module.</p>

<p>So here was my compromise:</p>

<p><code class="highlighter-rouge">JobAccess.activate_secret_extensions.bulk_insert(...)</code></p>

<p>The use here is that anyone <em>can</em> access the extensions by chaining the <code class="highlighter-rouge">activate_secret_extensions</code> method. It’s simply and clean to use. But the method name itself serves as the red flag that this isn’t a core feature and that it might not be the best solution unless you know what you’re doing.</p>

<p>The requirements here are that (1) <code class="highlighter-rouge">activate_secret_extensions</code> has to return an object that is like a JobAccess_Relation in all ways except that it has additional extnesions attached, <em>but</em> (2) these extensions have to be limited to this call and should <em>not</em> be added to <code class="highlighter-rouge">JobAccess</code> generally. Thus modifying the <code class="highlighter-rouge">JobAccess</code> class in place is not an option.</p>

<p>This is ruby, and classes are just objects. Objects have singleton classes (<a href="http://www.devalot.com/articles/2008/09/ruby-singleton">this</a> is a really good read on that if you are looking for one). When I see a task like this, I think of modifying the singleton class. This can work really well to add methods to a specific instance without affecting the class.</p>

<p>But there’s a problem. The instance here is in fact the constant class <code class="highlighter-rouge">JobAccess</code>. If we modify its singleton class, we’re modifying the singleton class of JobAccess itself. This violates requirement #2.</p>

<p>So at first I tried things like <code class="highlighter-rouge">dup</code>ing the class. This worked for the single line in question, but has the potential of leading to some major headaches because a lot of things depend on matching an ActiveRecord class or its name.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Extension</span><span class="p">;</span> <span class="k">def</span> <span class="nf">speak</span><span class="p">;</span> <span class="s2">"softly"</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span>
<span class="no">ExtendedJobAccess</span> <span class="o">=</span> <span class="no">JobAccess</span><span class="p">.</span><span class="nf">dup</span>
<span class="no">ExtendedJobAccess</span><span class="p">.</span><span class="nf">include</span><span class="p">(</span><span class="no">Extension</span><span class="p">)</span>
<span class="no">ExtendedJobAccess</span><span class="p">.</span><span class="nf">first</span>
<span class="c1"># =&gt; #&lt;ExtendedJobAccess id: ... &gt;</span>
<span class="no">ExtendedJobAccess</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">speak</span>
<span class="c1"># =&gt; "softly"</span>
<span class="no">JobAccess</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">speak</span>
<span class="c1"># NoMethodError: undefined method `speak' for #&lt;JobAccess:0x007fc27b130390&gt;</span>
</code></pre>
</div>

<p>So far so good…</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">ExtendedJobAccess</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">JobAccess</span>
<span class="c1"># =&gt; false</span>
</code></pre>
</div>

<p>Less good… this could break a lot of code. Things get even worse with STI models, since these rely on the class name. Consdier <code class="highlighter-rouge">TranscriptionService &lt; Service</code>:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">ExtendedTranscriptionService</span> <span class="o">=</span> <span class="no">TranscriptionService</span><span class="p">.</span><span class="nf">dup</span>
<span class="no">TranscriptionService</span><span class="p">.</span><span class="nf">count</span>
<span class="c1"># =&gt; 934997</span>
<span class="no">ExtendedTranscriptionService</span><span class="p">.</span><span class="nf">count</span>
<span class="c1"># =&gt; 0</span>
</code></pre>
</div>

<p>You can see why by examining the query:</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">`services`</span> <span class="k">WHERE</span> <span class="nv">`services`</span><span class="p">.</span><span class="nv">`type`</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'ExtendedTranscriptionService'</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="n">services</span><span class="p">.</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre>
</div>

<p>There are no elements of the <code class="highlighter-rouge">services</code> table that have `TYPE = ‘ExtendedTranscriptionService’. This is a show stopper.</p>

<p>Here’s the approach I settled on, which works quite well. You may have noticed that ActiveRecord blurs the lines between class methods and collection methods. You can define class methods on <code class="highlighter-rouge">JobAccess</code> and use them anywhere in a scope chain: <code class="highlighter-rouge">JobAccess.scope1.scope2.class_method1.scope3.class_method2</code> and so on. What’s actually going on is that these class methods on your model get defined as instance methods on a ActiveRecord_Relation model namespaced under your model:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">JobAccess</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">class</span>     <span class="c1">## Note: Rails 4 syntax. In Rails 3, use JobAccess.scoped</span>
<span class="c1"># =&gt; JobAccess::ActiveRecord_Relation</span>
</code></pre>
</div>

<p>This relation model contains all the methods you probably think of as “class” methods on your model:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">JobAccess</span><span class="o">::</span><span class="no">ActiveRecord_Relation</span><span class="p">.</span><span class="nf">instance_methods</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="ss">:where</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>

<p>This opens up a much neater approach. Since any query on the <em>class</em> <code class="highlighter-rouge">JobAccess</code> returns an <em>instance</em> of a <code class="highlighter-rouge">JobAcess::ActiveRecord_Relation</code>, we can modify the singleton class of this instance and we’re in the clear! The only remaining catch is that we want the methods to exist on <code class="highlighter-rouge">JobAccess</code> as well as the relation, but when we’re calling it from <code class="highlighter-rouge">JobAccess</code> itself we don’t yet have a relation. So we can create one:</p>

<p><a name="tl-dr-secret"></a></p>

<p>```ruby active_record_extension.rb
module ActiveRecordExtension
  module Base
    def activate_secret_extensions
      relation = self.is_a?(Class) ? self.all : self
      relation.singleton_class.include(ActiveRecordExtension::SecretExtension)
      return relation
    end
  end
end</p>

<p>ActiveRecord::Base.extend(ActiveRecordExtension::Base)</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
So now, 

 * All of `ActiveRecord::Base` has access to the method `activate_secret_extensions`
 * Calling `activate_secret_extensions` adds any methods defined in `ActiveRecordExtension::Base`, which is pasted below for reference.
 * ActiveRecord then for free gives us chainable methods for free -- this just just like defining class methods on `JobAccess`, except these method definitions are limited to this specific query. As a bonus, these methods do in fact propagate through the chain, so we only need to call `activate_secret_extensions` once for a given object in memory.

 Here's my current list of secretly-accepted extensions

```ruby active_record_extension.rb
module ActiveRecordExtension
  module SecretExtension
    def bulk_insert_sql(attribute_array)
      fields = attribute_array.first.keys
      values = attribute_array.map do |attrs|
        attrs.keys == fields or raise ArgumentError, "Attribute array must all have the same keys. Expected #{fields * ', '}, got #{attrs.keys * ', '}"
        fields.map{|key| self.sanitize(attrs[key])}
      end
      fields_string = "(" + fields.map{|f| "`" + f.to_s.gsub(/`/, "") + "`"} * ", " + ")"
      values_string = values.map{|vals| "(" + vals * ", " + ")"} * ", "
      return "INSERT INTO #{self.table_name} #{fields_string} VALUES #{values_string}"
    end

    def bulk_insert(attribute_array)
      return if attribute_array.empty?
      self.connection.execute(bulk_insert_sql(attribute_array))
    end

    # Simple left join taking advantage of existing Rails &amp; Arel code
    def left_joins(*args)
      inner_joins = self.joins(*args).arel.join_sources
      left_joins = inner_joins.map do |join|
        Arel::Nodes::OuterJoin.new(join.left, join.right)
      end
      self.joins(left_joins)
    end

    def _unscoped_joins(*args)
      arel = self.klass.all.arel
      unscoped_joins = self.joins(*args).arel.join_sources.map do |join|
        join_condition = join.right.expr.children.first
        foreign = join_condition.left.relation
        arel = arel.join(foreign).on(join_condition)
      end
      self.joins(arel.join_sources)
    end

    # Find records of self where no records of given association exist
    def without(assoc_name)
      assoc = self.reflect_on_association(assoc_name)
      self.left_joins(assoc_name).where(assoc.table_name =&gt; {assoc.klass.primary_key =&gt; nil})
    end

    # perform a count of results even if GROUP BY was issued
    def outer_count
      self.connection.execute("select COUNT(*) from (#{self.all.to_sql}) results").first.first
    end
  end

  module Base
    def activate_secret_extensions
      relation = self.is_a?(Class) ? self.all : self
      relation.singleton_class.include(ActiveRecordExtension::SecretExtension)
      return relation
    end
  end

end


ActiveRecord::Base.extend(ActiveRecordExtension::Base)

</code></pre>
</div>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Speak Softly</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Speak Softly
            
            </li>
            
            <li><a href="mailto:ozydingo@gmail.com">ozydingo@gmail.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/ozydingo"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">ozydingo</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/ozydingo"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">ozydingo</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>A blog about coding awesome, powerful tools...respectfully
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
